#!/bin/bash

# updates the infrastructure stack in CloudFormation

config_json=$( cat etc/config/config.json | jq )

stack_name=$( jq -r  '.aws.cloudformation.stack_name' <<< "${config_json}" ) 
artifact_bucket=$( jq -r  '.aws.s3.artifact_bucket' <<< "${config_json}" ) 
database_instance_type=$( jq -r  '.aws.opensearch.instance_type' <<< "${config_json}" )
database_username=$( jq -r  '.aws.opensearch.username' <<< "${config_json}" )
database_password=$( jq -r  '.aws.opensearch.password' <<< "${config_json}" )

aws s3 cp cft.yaml s3://$artifact_bucket/cft.yaml

aws cloudformation update-stack \
	--stack-name $stack_name \
	--template-url https://s3.amazonaws.com/$artifact_bucket/cft.yaml \
	--parameters \
		ParameterKey=StackName,ParameterValue=$stack_name \
		ParameterKey=HTTPSecurityKey,UsePreviousValue=true \
		ParameterKey=ArtifactBucket,ParameterValue=$artifact_bucket \
		ParameterKey=DatabaseInstanceType,ParameterValue=$database_instance_type \
		ParameterKey=DatabaseUsername,ParameterValue=$database_username \
		ParameterKey=DatabasePassword,ParameterValue=$database_password \
	--capabilities CAPABILITY_NAMED_IAM \
