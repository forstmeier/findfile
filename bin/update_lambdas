#!/bin/bash

# updates the AWS Lambdas with the pre-uploaded code files in S3

config_json=$( cat etc/config/config.json | jq '.aws' )

artifact_bucket=$( jq -r  '.s3.artifact_bucket' <<< "${config_json}" ) 

stack_name=$( jq -r  '.cloudformation.stack_name' <<< "${config_json}" )

stacks_info=$( aws cloudformation describe-stacks --stack-name $stack_name )

stack_outputs=$( jq -r  '.Stacks[0].Outputs' <<< "${stacks_info}" ) 

index_function_name=$( jq -r 'map(select(.OutputKey == "IndexFunctionName")) | .[0].OutputValue' <<< "${stack_outputs}" )
buckets_function_name=$( jq -r 'map(select(.OutputKey == "BucketsFunctionName")) | .[0].OutputValue' <<< "${stack_outputs}" )
documents_function_name=$( jq -r 'map(select(.OutputKey == "DocumentsFunctionName")) | .[0].OutputValue' <<< "${stack_outputs}" )
files_function_name=$( jq -r 'map(select(.OutputKey == "FilesFunctionName")) | .[0].OutputValue' <<< "${stack_outputs}" )

region=$( aws configure get region )

aws lambda update-function-code \
	--function-name $index_function_name \
	--s3-bucket $artifact_bucket \
	--s3-key index.zip \
	--region $region
aws lambda update-function-code \
	--function-name $buckets_function_name \
	--s3-bucket $artifact_bucket \
	--s3-key buckets.zip \
	--region $region
aws lambda update-function-code \
	--function-name $documents_function_name \
	--s3-bucket $artifact_bucket \
	--s3-key documents.zip \
	--region $region
aws lambda update-function-code \
	--function-name $files_function_name \
	--s3-bucket $artifact_bucket \
	--s3-key files.zip \
	--region $region
