#!/bin/bash

# creates and adds an access policy to the target S3 bucket
# for the Lambda to interact with

BUCKET_NAME=$1
LAMBDA_ROLE_ARN=$2

if [ -z "$BUCKET_NAME" ];
then
	echo "Bucket name argument not provided"
	exit 1
fi

if [ -z "$LAMBDA_ROLE_ARN" ];
then
	echo "Query Lambda role ARN argument not provided"
	exit 1
fi


BUCKET_RESOURCE="arn:aws:s3:::$BUCKET_NAME"

POLICY_DOCUMENT=$( jq -n \
	--arg bucket_resource $BUCKET_RESOURCE \
	--arg lambda_role_arn $LAMBDA_ROLE_ARN \
	'{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Effect": "Allow",
			"Principal": {
				"AWS": [
					$lambda_role_arn
				]
			},
			"Action": [
				"s3:*"
			],
			"Resource": $bucket_resource
		}
	]
}'
)

echo $POLICY_DOCUMENT > policy.json

aws s3api put-bucket-policy \
	--bucket $BUCKET_NAME \
	--policy file://policy.json

rm policy.json