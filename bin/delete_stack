#!/bin/bash

# removes the infrastructure stack via AWS CloudFormation

stack_name=$( cat etc/config/config.json | jq -r  '.aws.cloudformation.stack_name' )

stacks_info=$(aws cloudformation describe-stacks --stack-name $stack_name)

stack_outputs=$( jq -r  '.Stacks[0].Outputs' <<< "${stacks_info}" ) 

buckets_listener_logs_bucket=$( jq -r 'map(select(.OutputKey == "BucketsListenerBucketName")) | .[0].OutputValue' <<< "${stack_outputs}" )

aws s3 rm s3://$buckets_listener_logs_bucket --recursive

aws cloudformation delete-stack --stack-name $stack_name