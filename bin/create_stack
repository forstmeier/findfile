#!/bin/bash

# launches the infrastructure stack via AWS CloudFormation

config_json=$( cat etc/config/config.json | jq )

stack_name=$( jq -r  '.aws.cloudformation.stack_name' <<< "${config_json}" )
artifact_bucket=$( jq -r  '.aws.s3.artifact_bucket' <<< "${config_json}" )
instance_type=$( jq -r  '.aws.opensearch.instance_type' <<< "${config_json}" )
database_username=$( jq -r  '.aws.opensearch.username' <<< "${config_json}" )
database_password=$( jq -r  '.aws.opensearch.password' <<< "${config_json}" )

http_security_key=$(uuidgen)

aws cloudformation deploy \
	--template-file cft.yaml \
	--s3-bucket $artifact_bucket \
	--stack-name $stack_name \
	--parameter-overrides \
		StackName=$stack_name \
		HTTPSecurityKey=$http_security_key \
		ArtifactBucket=$artifact_bucket  \
		DatabaseInstanceType=$instance_type \
		DatabaseUsername=$database_username \
		DatabasePassword=$database_password \
	--capabilities CAPABILITY_NAMED_IAM \
	--no-fail-on-empty-changeset